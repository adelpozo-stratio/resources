{"id":"ad27a396-c909-4b1a-b541-62ae002f6c6f","name":"ot-ob-rw-4-send-to-gtscore-qa-def","description":"Send the json with the OK registers to GTS Core.","settings":{"global":{"executionMode":"marathon","userPluginsJars":[],"preExecutionSqlSentences":[],"postExecutionSqlSentences":[],"addAllUploadedPlugins":true,"mesosConstraint":"spark:true","mesosConstraintOperator":"LIKE","parametersLists":["Environment"],"parametersUsed":["COUNTRY","DATE","Environment.POSTGRE_ASINC_MS_ONBOARDING","Global.SFTP_HOST","Global.SFTP_PASS","Global.SFTP_USER","Global.SPARK_CORES_MAX","Global.SPARK_DRIVER_CORES","Global.SPARK_DRIVER_JAVA_OPTIONS","Global.SPARK_DRIVER_MEMORY","Global.SPARK_EXECUTOR_CORES","Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS","Global.SPARK_EXECUTOR_MEMORY","Global.SPARK_LOCALITY_WAIT","Global.SPARK_LOCAL_PATH","Global.SPARK_MEMORY_FRACTION","Global.SPARK_TASK_MAX_FAILURES"],"udfsToRegister":[],"udafsToRegister":[],"mesosRole":"","marathonDeploymentSettings":{"gracePeriodSeconds":"240","intervalSeconds":"20","timeoutSeconds":"20","maxConsecutiveFailures":"3","forcePullImage":true,"privileged":false,"userEnvVariables":[],"userLabels":[]},"enableQualityRules":true},"streamingSettings":{"window":"2s","blockInterval":"100ms","checkpointSettings":{"checkpointPath":"sparta/checkpoint","enableCheckpointing":true,"autoDeleteCheckpoint":true,"addTimeToCheckpointPath":false}},"sparkSettings":{"master":"mesos://zk://master.mesos:2181/mesos","sparkKerberos":true,"sparkDataStoreTls":true,"sparkMesosSecurity":true,"submitArguments":{"userArguments":[],"deployMode":"client","driverJavaOptions":"{{{Global.SPARK_DRIVER_JAVA_OPTIONS}}}"},"sparkConf":{"sparkResourcesConf":{"coresMax":"{{{Global.SPARK_CORES_MAX}}}","executorMemory":"{{{Global.SPARK_EXECUTOR_MEMORY}}}","executorCores":"{{{Global.SPARK_EXECUTOR_CORES}}}","driverCores":"{{{Global.SPARK_DRIVER_CORES}}}","driverMemory":"{{{Global.SPARK_DRIVER_MEMORY}}}","mesosExtraCores":"","localityWait":"{{{Global.SPARK_LOCALITY_WAIT}}}","taskMaxFailures":"{{{Global.SPARK_TASK_MAX_FAILURES}}}","sparkMemoryFraction":"{{{Global.SPARK_MEMORY_FRACTION}}}","sparkParallelism":""},"sparkHistoryServerConf":{"enableHistoryServerMonitoring":false,"sparkHistoryServerEventLogRotateEnable":false,"sparkHistoryServerEventLogRotateNum":"9","sparkHistoryServerEventLogRotateSize":"512"},"userSparkConf":[],"coarse":true,"sparkUser":"","sparkLocalDir":"{{{Global.SPARK_LOCAL_PATH}}}","sparkKryoSerialization":false,"sparkSqlCaseSensitive":true,"logStagesProgress":false,"hdfsTokenCache":true,"executorExtraJavaOptions":"{{{Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS}}}"}},"errorsManagement":{"genericErrorManagement":{"whenError":"Error"},"transformationStepsManagement":{"whenError":"Error","whenRowError":"RowError","whenFieldError":"FieldError"},"transactionsManagement":{"sendToOutputs":[],"sendStepData":false,"sendPredecessorsData":true,"sendInputData":true}}},"pipelineGraph":{"nodes":[{"name":"out_SFTP_jsonQROK","stepType":"Output","className":"SFTPOutputStep","classPrettyName":"SFTP","arity":["NullaryToNullary","NaryToNullary"],"description":"Send JSON_QROK to GTS Core.","uiConfiguration":{"position":{"x":2672.4389430623514,"y":177.6260069967268}},"configuration":{"path":"/gts/onetrade/Onboarding/{{{COUNTRY}}}/GTSINI/","errorSink":false,"host":"{{{Global.SFTP_HOST}}}","tlsEnabled":false,"fileType":"json","port":"22","sftpServerUsername":"{{{Global.SFTP_USER}}}","errorTableName":"","saveOptions":"[]","password":"{{{Global.SFTP_PASS}}}"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[],"outputsWriter":[]},{"name":"Json_OKData","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Creamos el JSON a enviar a GTS","uiConfiguration":{"position":{"x":2076.874906647536,"y":181.21250622506352}},"configuration":{"sql":"select collect_list(struct(\nIdentificador_legal_customer.*, \nSTRING(CONCAT(\"onboarding\",'{{{COUNTRY}}}','{{{DATE}}}',\".json\")) as fileName\n)) AS customer\n\tfrom Jo_OKData","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Rep_OKData","stepType":"Transformation","className":"RepartitionTransformStep","classPrettyName":"Repartition","arity":[],"uiConfiguration":{"position":{"x":2372.599748076265,"y":180.41359341733812}},"configuration":{"partitions":"1","columns":"[]","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[{"saveMode":"Append","outputStepName":"out_SFTP_jsonQROK","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_QROK","discardTableName":"","extraOptions":{"saveMode":"Append","partitionBy":""}},{"saveMode":"Overwrite","outputStepName":"out_JSON_JsonQROK","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_QROK","discardTableName":"","extraOptions":{"partitionBy":"","partitionOverwriteEnabled":false,"partitionColumns":"","saveMode":"Overwrite","partitions":""}}],"errorTableName":""},{"name":"out_JSON_JsonQROK","stepType":"Output","className":"JsonOutputStep","classPrettyName":"Json","arity":["NullaryToNullary","NaryToNullary"],"description":"Save locally the sent JSON.","uiConfiguration":{"position":{"x":2668.442276874654,"y":358.43536753054246}},"configuration":{"path":"hdfs://gts-hdfs/gts/data/raw/unformatted/onetrade/onboarding/{{{COUNTRY}}}/GTSINI/","errorSink":false,"saveOptions":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[],"outputsWriter":[]},{"name":"in_JSON_onboarding","stepType":"Input","className":"JsonInputStep","classPrettyName":"Json","arity":["NullaryToNary"],"description":"Onboarding json to intake","uiConfiguration":{"position":{"x":1028.0995109311975,"y":-72.60285007699144}},"configuration":{"path":"/gts/data/raw/formatted/onetrade/onboarding/{{{COUNTRY}}}/original/onboarding{{{COUNTRY}}}{{{DATE}}}/","inputOptions":"[]","debugOptions":"{\"fileUploaded\":\"hdfs:///user/gts-sparta/sparta/mockData/onboardingSPAIN20200121traceid.json\"}","errorTableName":""},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Jo_OKData","stepType":"Transformation","className":"JoinTransformStep","classPrettyName":"Join","arity":["BinaryToNary"],"uiConfiguration":{"position":{"x":1707.01557513246,"y":90.4861672065064}},"configuration":{"rightTable":"Fil_OK_traceId","leftTable":"Col_params","inputSchemas":"[]","joinConditions":[{"leftField":"Identificador_legal_customer.traceId","rightField":"trace_id"}],"errorTableName":"","joinType":"INNER","joinReturn":"LEFT"},"supportedEngines":["Batch","Streaming"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Expl_Identificadorlc","stepType":"Transformation","className":"ExplodeTransformStep","classPrettyName":"Explode","arity":["UnaryToNary"],"description":"Obtain a struct for every Identificadorlegalcustomer","uiConfiguration":{"position":{"x":1298.9969522367314,"y":-70.0456594734178}},"configuration":{"explodedField":"Identificador_legal_customer","inputSchemas":"[]","errorTableName":"","fieldsPreservationPolicy":"REPLACE","inputField":"customer"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Col_params","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"AÃ±ade:\ngts_id,\ntrace_id,\ncountry,\ndate,\ntimeOfIntake (will be the time of Validation)","uiConfiguration":{"position":{"x":1552.3455458969702,"y":-69.81124730253805}},"configuration":{"sql":"SELECT  *,\n  '{{{COUNTRY}}}' as param_country,\n  '{{{DATE}}}' as param_date\nFROM Expl_Identificadorlc\n\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"in_PG_process_log","stepType":"Input","className":"PostgresInputStepBatch","classPrettyName":"Postgres","arity":["NullaryToNary"],"uiConfiguration":{"position":{"x":1030.6041368677952,"y":228.66130346233172}},"configuration":{"inputOptions":"[]","url":"{{{Environment.POSTGRE_ASINC_MS_ONBOARDING}}}","debugOptions":"{\"query\":\"select\\n*\\n\\tfrom \\n\\t\\tGTS_ONETRADE.onboarding_pg_process_log\\nLIMIT 10\"}","isolationLevel":"READ_UNCOMMITTED","tlsEnabled":true,"caseSensitiveEnabled":true,"selectInput":"TABLE","dbtable":"onetradeonboardings.onboarding_process_log","errorTableName":""},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Fil_OK_traceId","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Filter OK registers. Select traceId.","uiConfiguration":{"position":{"x":1291.032908840452,"y":231.45658010417753}},"configuration":{"sql":"select\n\ttrace_id\n\tfrom \n\t\tin_PG_process_log\nwhere status_id = \"In_progress\" and step_id =\"Global_ID\" ","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""}],"edges":[{"origin":"Json_OKData","destination":"Rep_OKData","dataType":"ValidData"},{"origin":"Rep_OKData","destination":"out_SFTP_jsonQROK","dataType":"ValidData"},{"origin":"Rep_OKData","destination":"out_JSON_JsonQROK","dataType":"ValidData"},{"origin":"Expl_Identificadorlc","destination":"Col_params","dataType":"ValidData"},{"origin":"in_JSON_onboarding","destination":"Expl_Identificadorlc","dataType":"ValidData"},{"origin":"Col_params","destination":"Jo_OKData","dataType":"ValidData"},{"origin":"Jo_OKData","destination":"Json_OKData","dataType":"ValidData"},{"origin":"in_PG_process_log","destination":"Fil_OK_traceId","dataType":"ValidData"},{"origin":"Fil_OK_traceId","destination":"Jo_OKData","dataType":"ValidData"}],"annotations":[{"date":1579015311504,"author":"mirellaruiz","messages":[{"text":"LOS REGISTROS DADOS COMO OK QR SON ENVIADOS POR SFTP Y ALMACENAOS EN UN JSON EN HDFS","author":"mirellaruiz","date":1579015338634}],"color":"#ec445c","position":{"x":2116.505997443623,"y":43.345059155686876}}]},"executionEngine":"Batch","uiSettings":{"position":{"x":-361.67736589145306,"y":136.13512404486923,"k":0.4728803187341929}},"creationDate":"2020-02-03T08:41:14Z","lastUpdateDate":"2020-02-03T08:40:09Z","version":0,"group":{"id":"ab7361e4-761c-4883-afc8-b071f068f0dd","name":"/home/qa/onetrade-ot/onboarding-ob/raw/v1"},"debugMode":false,"versionSparta":"2.11.1-7a22d44","groupId":"ab7361e4-761c-4883-afc8-b071f068f0dd"}