{"id":"3a91a588-20f4-406b-861a-6b5903afadd4","name":"ot-ob-rw-6-gtscore-qa-def","description":"","settings":{"global":{"executionMode":"marathon","userPluginsJars":[],"preExecutionSqlSentences":[],"postExecutionSqlSentences":[],"addAllUploadedPlugins":true,"mesosConstraint":"spark:true","mesosConstraintOperator":"LIKE","parametersLists":["Environment"],"parametersUsed":["COUNTRY","DATE","Environment.KAFKA_BROKER_HOST_0","Environment.KAFKA_BROKER_HOST_1","Environment.KAFKA_BROKER_HOST_2","Environment.KAFKA_BROKER_PORT","Global.SPARK_CORES_MAX","Global.SPARK_DRIVER_CORES","Global.SPARK_DRIVER_JAVA_OPTIONS","Global.SPARK_DRIVER_MEMORY","Global.SPARK_EXECUTOR_CORES","Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS","Global.SPARK_EXECUTOR_MEMORY","Global.SPARK_LOCALITY_WAIT","Global.SPARK_LOCAL_PATH","Global.SPARK_MEMORY_FRACTION","Global.SPARK_TASK_MAX_FAILURES"],"udfsToRegister":[],"udafsToRegister":[],"mesosRole":"","marathonDeploymentSettings":{"gracePeriodSeconds":"240","intervalSeconds":"20","timeoutSeconds":"20","maxConsecutiveFailures":"3","forcePullImage":true,"privileged":false,"userEnvVariables":[],"userLabels":[],"logLevel":""},"enableQualityRules":true},"streamingSettings":{"window":"2s","blockInterval":"100ms","checkpointSettings":{"checkpointPath":"sparta/checkpoint","enableCheckpointing":true,"autoDeleteCheckpoint":true,"addTimeToCheckpointPath":false}},"sparkSettings":{"master":"mesos://zk://master.mesos:2181/mesos","sparkKerberos":true,"sparkDataStoreTls":true,"sparkMesosSecurity":true,"submitArguments":{"userArguments":[],"deployMode":"client","driverJavaOptions":"{{{Global.SPARK_DRIVER_JAVA_OPTIONS}}}"},"sparkConf":{"sparkResourcesConf":{"coresMax":"{{{Global.SPARK_CORES_MAX}}}","executorMemory":"{{{Global.SPARK_EXECUTOR_MEMORY}}}","executorCores":"{{{Global.SPARK_EXECUTOR_CORES}}}","driverCores":"{{{Global.SPARK_DRIVER_CORES}}}","driverMemory":"{{{Global.SPARK_DRIVER_MEMORY}}}","mesosExtraCores":"","localityWait":"{{{Global.SPARK_LOCALITY_WAIT}}}","taskMaxFailures":"{{{Global.SPARK_TASK_MAX_FAILURES}}}","sparkMemoryFraction":"{{{Global.SPARK_MEMORY_FRACTION}}}","sparkParallelism":""},"sparkHistoryServerConf":{"enableHistoryServerMonitoring":false,"sparkHistoryServerEventLogRotateEnable":false,"sparkHistoryServerEventLogRotateNum":"9","sparkHistoryServerEventLogRotateSize":"512"},"userSparkConf":[],"coarse":true,"sparkUser":"","sparkLocalDir":"{{{Global.SPARK_LOCAL_PATH}}}","sparkKryoSerialization":false,"sparkSqlCaseSensitive":true,"logStagesProgress":false,"hdfsTokenCache":true,"executorExtraJavaOptions":"{{{Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS}}}"}},"errorsManagement":{"genericErrorManagement":{"whenError":"Error"},"transformationStepsManagement":{"whenError":"Error","whenRowError":"RowError","whenFieldError":"FieldError"},"transactionsManagement":{"sendToOutputs":[],"sendStepData":false,"sendPredecessorsData":true,"sendInputData":true}}},"pipelineGraph":{"nodes":[{"name":"jsonGtsCore","stepType":"Input","className":"JsonInputStep","classPrettyName":"Json","arity":["NullaryToNary"],"uiConfiguration":{"position":{"x":-1002.4899872755982,"y":-270.7768640311382}},"configuration":{"path":"hdfs://gts-hdfs/gts/data/raw/unformatted/onetrade/onboarding/{{{COUNTRY}}}/GTSKO/onboarding{{{COUNTRY}}}{{{DATE}}}_GTSKO.json","inputOptions":"[]","debugOptions":"{\"fileUploaded\":\"hdfs:///user/gts-sparta/sparta/mockData/onboardingES20200130_GTSKO.json\"}","errorTableName":""},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"selGtsCore","stepType":"Transformation","className":"SelectTransformStep","classPrettyName":"Select","arity":["UnaryToNary"],"description":"Comprobaci√≥n columnas SF","uiConfiguration":{"position":{"x":-523.261685273645,"y":-271.27948854285694}},"configuration":{"selectType":"COLUMNS","columns":[{"name":"customer.companyGlobalId","alias":""},{"name":"customer.country","alias":""},{"name":"customer.description","alias":""},{"name":"customer.errorId","alias":""},{"name":"customer.fileName","alias":""},{"name":"customer.internalRepresentUser","alias":""},{"name":"customer.levelLogId","alias":""},{"name":"customer.mainErrorId","alias":""},{"name":"customer.statusId","alias":""},{"name":"customer.stepId","alias":""},{"name":"customer.stepTimestamp","alias":""},{"name":"customer.traceId","alias":""}],"inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"jsonGTSIni","stepType":"Input","className":"JsonInputStep","classPrettyName":"Json","arity":["NullaryToNary"],"description":"Tomo los datos del fichero inicial enviado a GTS y que ha pasado las QR","uiConfiguration":{"position":{"x":-806.8033112502075,"y":-3.277695635142095}},"configuration":{"path":"/gts/data/raw/unformatted/onetrade/onboarding/{{{COUNTRY}}}/GTSINI/onboarding{{{COUNTRY}}}{{{DATE}}}_QROK/","inputOptions":"[]","debugOptions":"{\"fileUploaded\":\"hdfs:///user/gts-sparta/sparta/mockData/onboardingSPAIN20200130.json\"}","errorTableName":""},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"ExplodeGtsIni","stepType":"Transformation","className":"ExplodeTransformStep","classPrettyName":"Explode","arity":["UnaryToNary"],"uiConfiguration":{"position":{"x":-542.7391633009887,"y":-5.01307771522022}},"configuration":{"explodedField":"customer","inputSchemas":"[]","errorTableName":"","fieldsPreservationPolicy":"REPLACE","inputField":"customer"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"joinGtsiniSf","stepType":"Transformation","className":"JoinTransformStep","classPrettyName":"Join","arity":["BinaryToNary"],"uiConfiguration":{"position":{"x":-148.68380441426996,"y":-127.1613626273296}},"configuration":{"rightTable":"selGtsCore","leftTable":"ExplodeGtsIni","inputSchemas":"[]","joinReturnColumns":[{"tableSide":"LEFT","column":"customer.traceId","alias":""},{"tableSide":"RIGHT","column":"description","alias":""},{"tableSide":"RIGHT","column":"errorId","alias":""},{"tableSide":"RIGHT","column":"levelLogId","alias":""},{"tableSide":"RIGHT","column":"mainErrorId","alias":""},{"tableSide":"RIGHT","column":"statusId","alias":""},{"tableSide":"RIGHT","column":"stepId","alias":""},{"tableSide":"RIGHT","column":"stepTimestamp","alias":""}],"joinConditions":[{"leftField":"customer.traceId","rightField":"traceId"}],"errorTableName":"","joinType":"LEFT","joinReturn":"COLUMNS"},"supportedEngines":["Batch","Streaming"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"FilKoOk","stepType":"Transformation","className":"FilterTransformStep","classPrettyName":"Filter","arity":["UnaryToNary"],"description":"Separo los registros que vienen con error a los que no vienen con error:\nstatusId null son los campos que no han venido en KO GTSKO.","uiConfiguration":{"position":{"x":83.1438235471528,"y":-126.45666472783063}},"configuration":{"filterExp":"statusId is null","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"sqlKo","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"uiConfiguration":{"position":{"x":368.2616132235513,"y":56.20587604336015}},"configuration":{"sql":"select \n\ttraceId, \n\tarray(struct(levelLogId,\n\t\t\t\t errorId,\n\t\t\t\t description, \n\t\t\t\t current_timestamp() as stepTimestamp, \n\t\t\t\t struct(statusId, null as description) as onboardingStatus, \n\t\t\t \tstruct(mainErrorId, null as description) as onboardingError, \n\t\t\t \tstruct (stepId, null as description) as onboardingStep)) \n\tas onboardingProcessLogs\nfrom FilKoOk_Discard","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Kafka","stepType":"Output","className":"KafkaOutputStep","classPrettyName":"Kafka","arity":["NullaryToNullary","NaryToNullary"],"uiConfiguration":{"position":{"x":1330.392903741576,"y":-244.6350545968354}},"configuration":{"value.serializer.outputFormat":"JSON","errorSink":false,"buffer.memory":"33554432","tlsEnabled":true,"security.protocol":"PLAINTEXT","bootstrap.servers":[{"host":"{{{Environment.KAFKA_BROKER_HOST_0}}}","port":"{{{Environment.KAFKA_BROKER_PORT}}}"},{"host":"{{{Environment.KAFKA_BROKER_HOST_1}}}","port":"{{{Environment.KAFKA_BROKER_PORT}}}"},{"host":"{{{Environment.KAFKA_BROKER_HOST_2}}}","port":"{{{Environment.KAFKA_BROKER_PORT}}}"}],"errorTableName":"","acks":"1","key.serializer.outputFormat":"JSON","ssl.client.auth":"none","saveOptions":"[]","batch.size":"16384"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[],"outputsWriter":[]},{"name":"sqlOk","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"uiConfiguration":{"position":{"x":321.3226064457617,"y":-411.81546065650366}},"configuration":{"sql":"select \n\ttraceId, \n\tarray(struct(levelLogId,\n\t\t\t\t errorId,\n\t\t\t\t description, \n\t\t\t\t current_timestamp() as stepTimestamp, \n\t\t\t\t struct(\"In_progress\" as statusId, null as description) as onboardingStatus, \n\t\t\t \tstruct(\"NA\" as mainErrorId, null as description) as onboardingError, \n\t\t\t \tstruct (\"Front\" as stepId, null as description) as onboardingStep)) \n\tas onboardingProcessLogs\nfrom FilKoOk\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"ExplodeGtsKo","stepType":"Transformation","className":"ExplodeTransformStep","classPrettyName":"Explode","arity":["UnaryToNary"],"uiConfiguration":{"position":{"x":-770.4412082280971,"y":-272.67092049576934}},"configuration":{"explodedField":"customer","inputSchemas":"[]","errorTableName":"","fieldsPreservationPolicy":"REPLACE","inputField":"customer"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Union","stepType":"Transformation","className":"UnionTransformStep","classPrettyName":"Union","arity":["NaryToNary"],"uiConfiguration":{"position":{"x":600.0297958839479,"y":-244.4369008719784}},"configuration":{"inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Repartition","stepType":"Transformation","className":"RepartitionTransformStep","classPrettyName":"Repartition","arity":[],"uiConfiguration":{"position":{"x":1050.3560713948668,"y":-243.9782515440519}},"configuration":{"partitions":"1","columns":"[]","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[{"saveMode":"Append","outputStepName":"Kafka","tableName":"onboardingChange","discardTableName":"","extraOptions":{"partitionBy":"","saveMode":"Append"}}]},{"name":"Trigger","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"uiConfiguration":{"position":{"x":154.33874779644145,"y":-534.8327616094572}},"configuration":{"sql":"SELECT \ncustomer.traceId,\ncustomer.processTimestamp,\ncustomer.country,\nconcat(\"onboarding\",'{{{COUNTRY}}}','{{{DATE}}}',\".json\") as fileName,\nnull as globalId,\ncustomer.companyGlobalId,\ncustomer.companyName,\ncustomer.cmc,\ncustomer.internalRepresentUser,\nstruct(\"Batch\" as onboardingId) as onboardingType\nfrom ExplodeGtsIni","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Join","stepType":"Transformation","className":"JoinTransformStep","classPrettyName":"Join","arity":["BinaryToNary"],"uiConfiguration":{"position":{"x":838.2201094142588,"y":-366.0543225351844}},"configuration":{"rightTable":"Union","leftTable":"Trigger","inputSchemas":"[]","joinReturnColumns":[{"tableSide":"LEFT","column":"cmc","alias":""},{"tableSide":"LEFT","column":"companyName","alias":""},{"tableSide":"LEFT","column":"country","alias":""},{"tableSide":"LEFT","column":"fileName","alias":""},{"tableSide":"LEFT","column":"globalId","alias":""},{"tableSide":"LEFT","column":"internalRepresentUser","alias":""},{"tableSide":"LEFT","column":"onboardingType","alias":""},{"tableSide":"LEFT","column":"companyGlobalId","alias":""},{"tableSide":"LEFT","column":"traceId","alias":""},{"tableSide":"LEFT","column":"processTimestamp","alias":""},{"tableSide":"RIGHT","column":"onboardingProcessLogs","alias":""}],"joinConditions":[{"leftField":"traceId","rightField":"traceId"}],"errorTableName":"","joinType":"INNER","joinReturn":"COLUMNS"},"supportedEngines":["Batch","Streaming"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]}],"edges":[{"origin":"jsonGTSIni","destination":"ExplodeGtsIni","dataType":"ValidData"},{"origin":"selGtsCore","destination":"joinGtsiniSf","dataType":"ValidData"},{"origin":"FilKoOk","destination":"sqlKo","dataType":"DiscardedData"},{"origin":"joinGtsiniSf","destination":"FilKoOk","dataType":"ValidData"},{"origin":"FilKoOk","destination":"sqlOk","dataType":"ValidData"},{"origin":"jsonGtsCore","destination":"ExplodeGtsKo","dataType":"ValidData"},{"origin":"ExplodeGtsKo","destination":"selGtsCore","dataType":"ValidData"},{"origin":"ExplodeGtsIni","destination":"joinGtsiniSf","dataType":"ValidData"},{"origin":"sqlOk","destination":"Union","dataType":"ValidData"},{"origin":"sqlKo","destination":"Union","dataType":"ValidData"},{"origin":"Repartition","destination":"Kafka","dataType":"ValidData"},{"origin":"ExplodeGtsIni","destination":"Trigger","dataType":"ValidData"},{"origin":"Trigger","destination":"Join","dataType":"ValidData"},{"origin":"Union","destination":"Join","dataType":"ValidData"},{"origin":"Join","destination":"Repartition","dataType":"ValidData"}],"annotations":[]},"executionEngine":"Batch","uiSettings":{"position":{"x":553.5876454565822,"y":270.0011179632698,"k":0.4562194944364248}},"creationDate":"2020-02-03T10:29:19Z","lastUpdateDate":"2020-02-03T10:15:11Z","version":0,"group":{"id":"ab7361e4-761c-4883-afc8-b071f068f0dd","name":"/home/qa/onetrade-ot/onboarding-ob/raw/v1"},"debugMode":false,"versionSparta":"2.11.1-7a22d44","groupId":"ab7361e4-761c-4883-afc8-b071f068f0dd"}