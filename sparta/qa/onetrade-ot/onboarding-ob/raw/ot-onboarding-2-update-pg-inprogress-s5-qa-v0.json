{"id":"620d2796-1824-4b8e-80ee-26b67446f42b","name":"ot-onboarding-2-update-pg-inprogress-s5-qa","description":"Update logs info with all the intake registers.","settings":{"global":{"executionMode":"marathon","userPluginsJars":[],"preExecutionSqlSentences":[],"postExecutionSqlSentences":[],"addAllUploadedPlugins":true,"mesosConstraint":"spark:true","mesosConstraintOperator":"LIKE","parametersLists":["Environment"],"parametersUsed":["COUNTRY","DATE","Environment.KAFKA_BROKER_HOST_0","Environment.KAFKA_BROKER_HOST_1","Environment.KAFKA_BROKER_HOST_2","Environment.KAFKA_BROKER_PORT","Global.SPARK_CORES_MAX","Global.SPARK_DRIVER_CORES","Global.SPARK_DRIVER_JAVA_OPTIONS","Global.SPARK_DRIVER_MEMORY","Global.SPARK_EXECUTOR_CORES","Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS","Global.SPARK_EXECUTOR_MEMORY","Global.SPARK_LOCALITY_WAIT","Global.SPARK_LOCAL_PATH","Global.SPARK_MEMORY_FRACTION","Global.SPARK_TASK_MAX_FAILURES"],"udfsToRegister":[],"udafsToRegister":[],"mesosRole":"","marathonDeploymentSettings":{"gracePeriodSeconds":"240","intervalSeconds":"20","timeoutSeconds":"20","maxConsecutiveFailures":"3","forcePullImage":true,"privileged":false,"userEnvVariables":[],"userLabels":[]},"enableQualityRules":true},"streamingSettings":{"window":"2s","blockInterval":"100ms","checkpointSettings":{"checkpointPath":"sparta/checkpoint","enableCheckpointing":true,"autoDeleteCheckpoint":true,"addTimeToCheckpointPath":false}},"sparkSettings":{"master":"mesos://zk://master.mesos:2181/mesos","sparkKerberos":true,"sparkDataStoreTls":true,"sparkMesosSecurity":true,"submitArguments":{"userArguments":[],"deployMode":"client","driverJavaOptions":"{{{Global.SPARK_DRIVER_JAVA_OPTIONS}}}"},"sparkConf":{"sparkResourcesConf":{"coresMax":"{{{Global.SPARK_CORES_MAX}}}","executorMemory":"{{{Global.SPARK_EXECUTOR_MEMORY}}}","executorCores":"{{{Global.SPARK_EXECUTOR_CORES}}}","driverCores":"{{{Global.SPARK_DRIVER_CORES}}}","driverMemory":"{{{Global.SPARK_DRIVER_MEMORY}}}","mesosExtraCores":"","localityWait":"{{{Global.SPARK_LOCALITY_WAIT}}}","taskMaxFailures":"{{{Global.SPARK_TASK_MAX_FAILURES}}}","sparkMemoryFraction":"{{{Global.SPARK_MEMORY_FRACTION}}}","sparkParallelism":""},"sparkHistoryServerConf":{"enableHistoryServerMonitoring":false,"sparkHistoryServerEventLogRotateEnable":false,"sparkHistoryServerEventLogRotateNum":"9","sparkHistoryServerEventLogRotateSize":"512"},"userSparkConf":[],"coarse":true,"sparkUser":"","sparkLocalDir":"{{{Global.SPARK_LOCAL_PATH}}}","sparkKryoSerialization":false,"sparkSqlCaseSensitive":true,"logStagesProgress":false,"hdfsTokenCache":true,"executorExtraJavaOptions":"{{{Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS}}}"}},"errorsManagement":{"genericErrorManagement":{"whenError":"Error"},"transformationStepsManagement":{"whenError":"Error","whenRowError":"RowError","whenFieldError":"FieldError"},"transactionsManagement":{"sendToOutputs":[],"sendStepData":false,"sendPredecessorsData":true,"sendInputData":true}}},"pipelineGraph":{"nodes":[{"name":"Expl_Identificadorlc","stepType":"Transformation","className":"ExplodeTransformStep","classPrettyName":"Explode","arity":["UnaryToNary"],"description":"Obtain a struct for every Identificadorlegalcustomer","uiConfiguration":{"position":{"x":-67.54171001686143,"y":206.66213134972543}},"configuration":{"explodedField":"Identificador_legal_customer","inputSchemas":"[]","errorTableName":"","fieldsPreservationPolicy":"REPLACE","inputField":"customer"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Col_params","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Añade:\ngts_id,\ntrace_id,\ncountry,\ndate,\ntimeOfIntake (timestamp para el estado \"In_progress\"),\n  'DATA' as step, \n  'In_progress' as status,\n  'NA' as log,\n  'NA' as error,\n  'NA' as qa_error,\n  'NA' as description,\n  'Batch' as onboarding","uiConfiguration":{"position":{"x":196.627704452207,"y":210.29451794877946}},"configuration":{"sql":"SELECT \n*,\n  cast(\n\thash(concat(\n\t\tnvl(Identificador_legal_customer.companyId,randn()),\n\t\tsoundex(nvl(Identificador_legal_customer.country,randn())),\n\t\t\"OT\",\n\t\tnvl(Identificador_legal_customer.companyName,randn())\n\t  )) as string) \n  as companyGlobalId,\n  sha2(concat(\n\t  nvl(Identificador_legal_customer.companyId, randn()),\n\t  nvl(Identificador_legal_customer.internalRepresentUser, randn()),\n\t  nvl(Identificador_legal_customer.country, randn()),\n\t  current_timestamp()\n\t  ),256) \n  as traceId,\n  '{{{COUNTRY}}}' as param_country,\n  '{{{DATE}}}' as param_date,\n  current_timestamp() as timeOfIntake,\n  'Data' as step, \n  'In_progress' as status,\n  null as log,\n  'NA' as error,\n  null as qa_error,\n  null as description,\n  'Batch' as onboarding\nFROM Expl_Identificadorlc\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Json_original_and_traceId","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Guardamos el JSON original añadiendo los campos de company_global_id y trace_id","uiConfiguration":{"position":{"x":627.9116837545525,"y":-173.94642777423041}},"configuration":{"sql":"select collect_list(struct(\nIdentificador_legal_customer.*, \nSTRING(companyGlobalId) as companyGlobalId, \nSTRING(traceId) as traceId)) AS customer\n\tfrom Col_params","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Rep_original_and_traceId","stepType":"Transformation","className":"RepartitionTransformStep","classPrettyName":"Repartition","arity":[],"uiConfiguration":{"position":{"x":883.7410173707813,"y":-172.9996588192605}},"configuration":{"partitions":"1","columns":"[]","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[{"saveMode":"Overwrite","outputStepName":"out_JSON_original_and_traceid","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}","discardTableName":"","extraOptions":{"partitionBy":"","partitionOverwriteEnabled":false,"partitionColumns":"","saveMode":"Overwrite","partitions":""}}],"errorTableName":""},{"name":"out_JSON_original_and_traceid","stepType":"Output","className":"JsonOutputStep","classPrettyName":"Json","arity":["NullaryToNullary","NaryToNullary"],"description":"Save in RF the original JSON with traceIds and companyGlobalId.","uiConfiguration":{"position":{"x":1287.326588161358,"y":-171.11504596093897}},"configuration":{"path":"hdfs://gts-hdfs/gts/data/raw/formatted/onetrade/onboarding/{{{COUNTRY}}}/original/","errorSink":false,"saveOptions":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[],"outputsWriter":[]},{"name":"in_JSON_onboarding","stepType":"Input","className":"JsonInputStep","classPrettyName":"Json","arity":["NullaryToNary"],"description":"Onboarding json to intake","uiConfiguration":{"position":{"x":-337.7599034636146,"y":208.23643196287804}},"configuration":{"path":"/gts/data/raw/unformatted/onetrade/onboarding/{{{COUNTRY}}}/original/onboarding{{{COUNTRY}}}{{{DATE}}}.json","inputOptions":"[]","debugOptions":"{\"fileUploaded\":\"hdfs:///user/gts-sparta/sparta/mockData/onboardingES20200127.json\"}","errorTableName":""},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Sel_process_log","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Select process log table data.","uiConfiguration":{"position":{"x":695.709192321529,"y":295.1696020860569}},"configuration":{"sql":"SELECT \ntraceId,\ncollect_set(struct(\n      log as levelLogId,\n  \t  qa_error as errorId,\n  \t  description,\n      timeOfIntake as stepTimestamp,\n  \t  struct(status as statusId) as onboardingStatus,\n  \t  struct(step as stepId) as onboardingStep,\n   \t  struct(error as mainErrorId) as onboardingError\n)) as onboardingProcessLogs\nfrom Col_params\ngroup by traceId","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Sel_process","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Select process and user data.","uiConfiguration":{"position":{"x":705.8213444211384,"y":76.77755801867409}},"configuration":{"sql":"SELECT \ntraceId,\ntimeOfIntake as processTimestamp,\nIdentificador_legal_customer.country,\nconcat(\"onboarding\",param_country,param_date,\".json\") as fileName,\n'' as globalId,\ncompanyGlobalId,\nIdentificador_legal_customer.companyName,\nIdentificador_legal_customer.cmc,\nIdentificador_legal_customer.internalRepresentUser,\nstruct(onboarding as onboardingId, null as description) as onboardingType\nfrom Col_params\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Jo_Logs","stepType":"Transformation","className":"JoinTransformStep","classPrettyName":"Join","arity":["BinaryToNary"],"description":"Join and then creates JSON with logs for Kafka.","uiConfiguration":{"position":{"x":993.0085925964858,"y":194.07935683138587}},"configuration":{"rightTable":"Sel_process_log","leftTable":"Sel_process","inputSchemas":"[]","joinReturnColumns":[{"tableSide":"LEFT","column":"cmc","alias":""},{"tableSide":"LEFT","column":"companyGlobalId","alias":""},{"tableSide":"LEFT","column":"companyName","alias":""},{"tableSide":"LEFT","column":"country","alias":""},{"tableSide":"LEFT","column":"fileName","alias":""},{"tableSide":"LEFT","column":"globalId","alias":""},{"tableSide":"LEFT","column":"internalRepresentUser","alias":""},{"tableSide":"LEFT","column":"onboardingType","alias":""},{"tableSide":"LEFT","column":"processTimestamp","alias":""},{"tableSide":"LEFT","column":"traceId","alias":""},{"tableSide":"RIGHT","column":"onboardingProcessLogs","alias":""}],"joinConditions":[{"leftField":"traceId","rightField":"traceId"}],"errorTableName":"","joinType":"INNER","joinReturn":"COLUMNS"},"supportedEngines":["Batch","Streaming"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"out_Kafka","stepType":"Output","className":"KafkaOutputStep","classPrettyName":"Kafka","arity":["NullaryToNullary","NaryToNullary"],"uiConfiguration":{"position":{"x":1729.2555546623396,"y":195.19593320483}},"configuration":{"value.serializer.outputFormat":"JSON","errorSink":false,"buffer.memory":"33554432","tlsEnabled":true,"security.protocol":"PLAINTEXT","bootstrap.servers":[{"host":"{{{Environment.KAFKA_BROKER_HOST_0}}}","port":"{{{Environment.KAFKA_BROKER_PORT}}}"},{"host":"{{{Environment.KAFKA_BROKER_HOST_1}}}","port":"{{{Environment.KAFKA_BROKER_PORT}}}"},{"host":"{{{Environment.KAFKA_BROKER_HOST_2}}}","port":"{{{Environment.KAFKA_BROKER_PORT}}}"}],"errorTableName":"","acks":"1","key.serializer.outputFormat":"JSON","ssl.client.auth":"none","saveOptions":"[]","batch.size":"16384"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[],"outputsWriter":[]},{"name":"Rep_logs","stepType":"Transformation","className":"RepartitionTransformStep","classPrettyName":"Repartition","arity":[],"uiConfiguration":{"position":{"x":1316.331927751885,"y":193.14162675804226}},"configuration":{"partitions":"1","columns":"[]","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[{"saveMode":"Append","outputStepName":"out_Kafka","tableName":"onboardingChange","discardTableName":"","extraOptions":{"partitionBy":"","saveMode":"Append"}}]}],"edges":[{"origin":"Expl_Identificadorlc","destination":"Col_params","dataType":"ValidData"},{"origin":"Json_original_and_traceId","destination":"Rep_original_and_traceId","dataType":"ValidData"},{"origin":"Rep_original_and_traceId","destination":"out_JSON_original_and_traceid","dataType":"ValidData"},{"origin":"Col_params","destination":"Json_original_and_traceId","dataType":"ValidData"},{"origin":"in_JSON_onboarding","destination":"Expl_Identificadorlc","dataType":"ValidData"},{"origin":"Col_params","destination":"Sel_process_log","dataType":"ValidData"},{"origin":"Col_params","destination":"Sel_process","dataType":"ValidData"},{"origin":"Sel_process_log","destination":"Jo_Logs","dataType":"ValidData"},{"origin":"Sel_process","destination":"Jo_Logs","dataType":"ValidData"},{"origin":"Jo_Logs","destination":"Rep_logs","dataType":"ValidData"},{"origin":"Rep_logs","destination":"out_Kafka","dataType":"ValidData"}],"annotations":[]},"executionEngine":"Batch","uiSettings":{"position":{"x":252.51570837821362,"y":179.17267085478414,"k":0.4867726447333949}},"lastUpdateDate":"2020-01-29T18:04:20Z","version":0,"group":{"id":"8667062a-9a0e-425d-ad11-4639f4601072","name":"/home/qa/onetrade-ot/onboarding-ob/raw"},"debugMode":false,"versionSparta":"2.11.1-7a22d44","groupId":"8667062a-9a0e-425d-ad11-4639f4601072"}